import ipaddress
import sys
import threading
from typing import Type, List

from PyQt5.QtWidgets import QMainWindow, QApplication, QDialog, QTableWidgetItem, QLabel, QToolButton, QWidget, QTableWidget, QListWidget, QPushButton, QCheckBox, QSpinBox, QMenuBar, QProgressBar, QStatusBar, QTextEdit
from PyQt5.QtCore import QRect, Qt, QSize
from PyQt5.uic import loadUi
from backend import Backend
from database import HostsDataTable, base_session
from vpn_brute import PPTPBrute
from consts import TableColumnsConsts


class MainMenu(QMainWindow):
    def __init__(self):
        super().__init__()
        self.hosts_popup = HostsPopup(self)
        self.ports_popup = PortsPopup(self)
        self.pptp_popup = PPTPPopup(self)
        self.init_ui()
        self.scan_thread = Type[threading.Thread]
        self.show()

    def init_ui(self):

        self.resize(800, 600)
        self.setWindowTitle('SubnetPentest')
        self.centralwidget = QWidget(self)

        self.tableWidget = QTableWidget(parent=self.centralwidget, columnCount=6, geometry=QRect(20, 170, 761, 361))
        self.tableWidget.setHorizontalHeaderLabels(TableColumnsConsts.fields.value)
        self.tableWidget.setMinimumSize(QSize(700, 0))
        self.tableWidget.setGridStyle(Qt.DashLine)
        self.tableWidget.setSortingEnabled(True)

        self.portsList = QListWidget(self.centralwidget)
        self.portsList.setGeometry(QRect(20, 40, 70, 100))

        self.ports_label = QLabel(self.centralwidget, text='Ports')
        self.ports_label.setGeometry(QRect(20, 10, 66, 19))

        self.portsBtn = QToolButton(self.centralwidget, text='...')
        self.portsBtn.setGeometry(QRect(70, 10, 20, 20))
        self.portsBtn.clicked.connect(self.ports_popup.show)

        self.hosts_label = QLabel(self.centralwidget, text='Hosts')
        self.hosts_label.setGeometry(QRect(110, 10, 66, 19))

        self.hostsList = QListWidget(self.centralwidget)
        self.hostsList.setGeometry(QRect(110, 40, 191, 101))

        self.hostsBtn = QToolButton(self.centralwidget, text='...')
        self.hostsBtn.setGeometry(QRect(280, 10, 20, 20))
        self.hostsBtn.clicked.connect(self.hosts_popup.show)

        self.modulesCheckbox = QCheckBox(self.centralwidget, text='Modules')
        self.modulesCheckbox.setGeometry(QRect(330, 10, 131, 25))
        self.modulesCheckbox.stateChanged.connect(self.modules_onclick)

        self.modulesList = QListWidget(self.centralwidget, enabled=False)
        self.modulesList.setGeometry(QRect(330, 40, 191, 101))

        self.modulesBtn = QToolButton(self.centralwidget, enabled=False, text='...')
        self.modulesBtn.setGeometry(QRect(500, 10, 21, 21))

        self.scanBtn = QPushButton(self.centralwidget, enabled=False, text='Scan')
        self.scanBtn.setGeometry(QRect(550, 90, 111, 27))
        self.scanBtn.clicked.connect(self.scan_start)

        self.threads_spin = QSpinBox(self.centralwidget, maximum=999, minimum=1, value=300)
        self.threads_spin.setGeometry(QRect(550, 40, 61, 28))

        self.threads_label = QLabel(self.centralwidget, text='Threads:')
        self.threads_label.setGeometry(QRect(550, 20, 66, 19))

        self.timeout_label = QLabel(self.centralwidget, text='Timeout (s):')
        self.timeout_label.setGeometry(QRect(630, 20, 81, 19))

        self.timeout_spin = QSpinBox(self.centralwidget, minimum=1, value=10)
        self.timeout_spin.setGeometry(QRect(630, 40, 61, 28))

        self.currentHost_label = QLabel(self.centralwidget)
        self.currentHost_label.setGeometry(QRect(20, 540, 291, 21))

        self.quantityLabelText = QLabel(self.centralwidget, text='Count')
        self.quantityLabelText.setGeometry(QRect(180, 10, 41, 19))

        self.quantityLabel = QLabel(self.centralwidget, text='0')
        self.quantityLabel.setGeometry(QRect(235, 10, 41, 20))

        self.pptpBtn = QPushButton(self.centralwidget, enabled=False, text='PPTP scan')
        self.pptpBtn.setGeometry(QRect(670, 90, 111, 27))
        self.pptpBtn.clicked.connect(self.pptp_popup.show)

        self.progressBar = QProgressBar(self.centralwidget, value=0)
        self.progressBar.setGeometry(QRect(360, 540, 421, 23))

        self.setCentralWidget(self.centralwidget)

    def scan_start(self):
        # clear tablewidget
        self.tableWidget.clearContents()
        self.tableWidget.setRowCount(0)

        # clear progressBar
        self.progressBar.setValue(0)

        self.set_modules_status(False)
        self.pptpBtn.setEnabled(False)
        self.scan_thread = threading.Thread(target=Backend.run)
        self.scan_thread.start()
        self.scanBtn.clicked.disconnect(self.scan_start)
        self.scanBtn.clicked.connect(self.scan_stop)
        self.scanBtn.setText('Stop')

    def scan_stop(self):
        self.scanBtn.setEnabled(False)
        self.currentHost_label.setText(f'Wait for stop {threading.active_count() - Backend.threads_orig} threads')
        Backend.scan_stop_event.set()

    def switch_btn_state(self):
        if self.hostsList.count() > 0:
            self.pptpBtn.setEnabled(True)
        else:
            self.pptpBtn.setEnabled(False)
        if self.hostsList.count() > 0 and self.portsList.count() > 0:
            self.scanBtn.setEnabled(True)
        else:
            self.scanBtn.setEnabled(False)

    def set_modules_status(self, status: bool):
        self.modulesCheckbox.setEnabled(status)
        self.modulesList.setEnabled(status)
        self.modulesBtn.setEnabled(status)

    def modules_onclick(self, state):
        if state == 2:
            self.modulesList.setEnabled(True)
            self.modulesBtn.setEnabled(True)
        else:
            self.modulesList.setEnabled(False)
            self.modulesBtn.setEnabled(False)


class PPTPPopup(QDialog):

    def __init__(self, main_menu: MainMenu):
        super().__init__()
        self.main_menu = main_menu
        loadUi('ui/pptp.ui', self)
        self.scanBtn.clicked.connect(self.run_pptp_scan)

    def run_pptp_scan(self):
        hosts: List[str] = list()
        if self.useBase.isChecked():
            hosts.extend(map(lambda l: l.host, base_session.query(HostsDataTable).where(HostsDataTable.port == 1723)))
        if self.useHosts.isChecked():
            for line in Backend.ip_networks:
                hosts.append(str(line))
        # FIXME add selectable credentials
        credentials = open('credentials.txt').read().split('\n')
        for host in hosts:
            for line in credentials:
                login, password = line.split(':')
                result = PPTPBrute.connect_attempt(host=host, login=login, password=password)
                if result:
                    current_row = self.main_menu.tableWidget.rowCount()
                    self.main_menu.tableWidget.insertRow(current_row)
                    self.main_menu.tableWidget.setItem(current_row, TableColumnsConsts.host.value, QTableWidgetItem(host))
                    self.main_menu.tableWidget.setItem(current_row, TableColumnsConsts.port.value, QTableWidgetItem('1723'))


class HostsPopup(QDialog):

    def __init__(self, main_menu: MainMenu):
        super().__init__()
        self.main_menu = main_menu
        self.init_ui()

    def init_ui(self):
        self.resize(498, 370)

        self.hostsEdit = QTextEdit(self)
        self.hostsEdit.setGeometry(QRect(10, 150, 371, 191))

        self.clearBtn = QPushButton(self, text='Clear')
        self.clearBtn.setGeometry(QRect(390, 260, 87, 27))
        self.clearBtn.clicked.connect(self.hostsEdit.clear)

        self.saveBtn = QPushButton(self, text='Save')
        self.saveBtn.setGeometry(QRect(390, 310, 87, 27))
        self.saveBtn.clicked.connect(self.save)

        self.info_label = QLabel(self, text= u"<html><head/><body><p>Examples of addreses and ip ranges:</p><p>1. 192.168.1.1</p><p>2. 192.168.1.1-192.168.1.255</p><p>3. 192.168.1.1/24</p></body></html>")
        self.info_label.setGeometry(QRect(10, 20, 261, 111))

        self.warning_label = QLabel(self)
        self.warning_label.setGeometry(QRect(300, 20, 181, 111))

    def show(self):
        text = str()
        for ip in Backend.ip_networks:
            text += f'{ip}\n'
        text = text[:-1]
        self.hostsEdit.setText(text)
        super().show()

    def save(self):
        lines = []
        quantity = 0
        # TODO move it to backend
        for num, line in enumerate(self.hostsEdit.toPlainText().split(), start=1):
            if Backend.host_pattern.match(line):
                quantity += 1
                lines.append((ipaddress.IPv4Address(line),))
            elif Backend.host_range_pattern.match(line):
                start, end = map(ipaddress.IPv4Address, line.split('-'))
                network = next(ipaddress.summarize_address_range(start, end))
                quantity += network.num_addresses
                lines.append(network)
            elif Backend.host_cidr_pattern.match(line):
                network = ipaddress.ip_network(line, strict=False)
                quantity += network.num_addresses
                lines.append(network)
            else:
                self.warning_label.setText(f'Error in line {num}')
                return None
        Backend.ip_networks = lines
        self.main_menu.quantityLabel.setText(str(quantity))
        self.main_menu.hostsList.clear()
        self.main_menu.hostsList.addItems(self.hostsEdit.toPlainText().split())
        self.main_menu.switch_btn_state()
        self.close()


class PortsPopup(QDialog):

    def __init__(self, main_menu: MainMenu):
        super().__init__()
        self.main_menu = main_menu
        loadUi('ui/addPorts.ui', self)
        self.saveBtn.clicked.connect(self.save)

    def save(self):
        ports = self.portsEdit.toPlainText().split()
        for num, port in enumerate(ports, start=1):
            if not Backend.port_pattern.match(port):
                self.label.setText(f'Error in line {num}')
                return None
        Backend.ports = ports
        self.main_menu.portsList.clear()
        self.main_menu.portsList.addItems(Backend.ports)
        self.main_menu.switch_btn_state()
        self.close()


if __name__ == '__main__':
    app = QApplication(sys.argv)
    Backend.frontend = MainMenu()
    sys.exit(app.exec_())
